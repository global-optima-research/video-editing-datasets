# ProPainter 深度分析

> ProPainter: Improving Propagation and Transformer for Video Inpainting (ICCV 2023)

**论文**: [arxiv.org/abs/2309.03897](https://arxiv.org/abs/2309.03897)
**代码**: [github.com/sczhou/ProPainter](https://github.com/sczhou/ProPainter)
**项目**: [shangchenzhou.com/projects/ProPainter](https://shangchenzhou.com/projects/ProPainter/)

---

## 核心贡献

1. **双域传播 (Dual-Domain Propagation)**: 结合图像域和特征域的传播
2. **循环光流补全 (Recurrent Flow Completion)**: 更准确的运动估计
3. **掩码引导稀疏 Transformer**: 高效的全局注意力
4. **SOTA 性能**: 超越之前方法 1.46 dB PSNR

---

## 为什么对 PVTT 重要

```
PVTT Pipeline 中 ProPainter 的角色:

模板视频                                              合成视频
    │                                                    ↑
    ↓                                                    │
 SAM2 分割 → Mask 序列 ──→ ProPainter ──→ 干净背景 ──────┤
                              │                          │
                              │                          │
                              └─── 移除原商品 ───────────┘
                                        │
新商品图 + Box 序列 ──→ VideoAnyDoor ───┘
```

**关键作用**:
1. 移除模板视频中的原商品
2. 生成时序一致的干净背景
3. 为 VideoAnyDoor 插入新商品提供画布

---

## 架构设计

### 整体 Pipeline

```
┌─────────────────────────────────────────────────────────────────┐
│                     ProPainter Pipeline                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  输入: 视频帧 + Mask 序列                                        │
│                    ↓                                             │
│  ┌──────────────────────────────────────────────┐               │
│  │  Stage 1: Recurrent Flow Completion          │               │
│  │  输入光流 → 补全被遮挡区域的光流             │               │
│  └──────────────────────────────────────────────┘               │
│                    ↓                                             │
│  ┌──────────────────────────────────────────────┐               │
│  │  Stage 2: Dual-Domain Propagation            │               │
│  │  图像域 Warping + 特征域 Warping             │               │
│  └──────────────────────────────────────────────┘               │
│                    ↓                                             │
│  ┌──────────────────────────────────────────────┐               │
│  │  Stage 3: Mask-Guided Sparse Transformer     │               │
│  │  全局注意力填充剩余区域                      │               │
│  └──────────────────────────────────────────────┘               │
│                    ↓                                             │
│  输出: 修复后的视频帧                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 各阶段详解

### Stage 1: Recurrent Flow Completion

**问题**: 被遮挡区域的光流缺失，无法直接传播

**解决方案**:
```
┌─────────────────────────────────────────────────────────────────┐
│  循环光流补全网络                                                │
│                                                                  │
│  F_{t→t+1} (带遮挡)                                             │
│       ↓                                                          │
│  双向传播:                                                       │
│  - 前向: F_{t-1→t} → 预测 F_{t→t+1}                             │
│  - 后向: F_{t+1→t+2} → 预测 F_{t→t+1}                           │
│       ↓                                                          │
│  融合 + 精炼                                                     │
│       ↓                                                          │
│  F_{t→t+1} (完整)                                               │
└─────────────────────────────────────────────────────────────────┘
```

**关键创新**:
- 循环结构利用时序信息
- 双向传播提高遮挡区域准确性
- 比直接预测更稳定

### Stage 2: Dual-Domain Propagation

**核心思想**: 同时在图像域和特征域传播信息

```
┌─────────────────────────────────────────────────────────────────┐
│  图像域传播                    特征域传播                        │
│                                                                  │
│  I_{t-1} ──warp──→ Ĩ_t        E_{t-1} ──warp──→ Ẽ_t            │
│       (补全光流)                   (补全光流)                    │
│                                                                  │
│  特点: 保留纹理细节            特点: 保留语义信息                │
│  问题: 累积误差                问题: 细节丢失                    │
│                                                                  │
│              ↓           融合            ↓                       │
│              └──────────────────────────┘                        │
│                         ↓                                        │
│               互补: 细节 + 语义                                  │
└─────────────────────────────────────────────────────────────────┘
```

**为什么双域更好**:

| 传播方式 | 优点 | 缺点 |
|----------|------|------|
| 纯图像域 | 纹理细节好 | 累积误差，失真 |
| 纯特征域 | 语义一致 | 细节模糊 |
| **双域** | 两者兼得 | 计算量稍大 |

### Stage 3: Mask-Guided Sparse Transformer

**问题**: 传播无法到达的区域需要全局推理

**解决方案**: 稀疏 Transformer，只计算相关 token

```
┌─────────────────────────────────────────────────────────────────┐
│  Mask-Guided Sparse Attention                                    │
│                                                                  │
│  输入: 传播后的帧 (部分区域仍缺失)                              │
│                                                                  │
│  Token 采样:                                                     │
│  - Mask 内: 所有 token (需要填充)                               │
│  - Mask 外: 稀疏采样 (提供上下文)                               │
│                                                                  │
│  Attention:                                                      │
│  Query: Mask 内的 token                                         │
│  Key/Value: Mask 外的稀疏 token                                 │
│                                                                  │
│  优势: 复杂度从 O(N²) 降至 O(N·K)，K << N                       │
└─────────────────────────────────────────────────────────────────┘
```

**效率对比**:

| 方法 | 复杂度 | 1080p 速度 |
|------|--------|------------|
| 全注意力 | O(N²) | ~0.5 FPS |
| 稀疏注意力 | O(N·K) | ~10 FPS |

---

## 与其他方法对比

### 定量对比

| 方法 | DAVIS PSNR ↑ | DAVIS SSIM ↑ | YouTube-VOS PSNR ↑ |
|------|--------------|--------------|-------------------|
| STTN | 32.34 | 0.962 | 32.28 |
| FuseFormer | 33.24 | 0.968 | 33.52 |
| E²FGVI | 33.71 | 0.969 | 33.69 |
| **ProPainter** | **35.17** | **0.976** | **35.15** |

**提升**: +1.46 dB PSNR (相比 E²FGVI)

### 定性对比

| 场景 | STTN | E²FGVI | ProPainter |
|------|------|--------|------------|
| 静态背景 | ✅ | ✅ | ✅ |
| 动态背景 | ⚠️ 抖动 | ⚠️ 模糊 | ✅ 清晰 |
| 大面积遮挡 | ❌ 失真 | ⚠️ 伪影 | ✅ 自然 |
| 复杂运动 | ❌ 撕裂 | ⚠️ 残影 | ✅ 流畅 |

---

## PVTT 场景适用性

### 商品移除示例

```
输入:                    输出:
┌─────────────────┐     ┌─────────────────┐
│     ┌─────┐     │     │                 │
│     │手表 │     │ ──→ │  干净的手腕     │
│     └─────┘     │     │                 │
│    (手腕上)     │     │                 │
└─────────────────┘     └─────────────────┘
```

### 处理难点

| 场景 | 难度 | ProPainter 表现 |
|------|------|-----------------|
| 手腕上的手表 | ⚠️ 中 | ✅ 自然恢复皮肤纹理 |
| 复杂背景商品 | ⚠️ 中 | ✅ 保持背景一致性 |
| 快速移动商品 | ⚠️ 中 | ✅ 运动模糊正确处理 |
| 大面积商品 | ⚠️ 高 | ⚠️ 可能需要多帧参考 |

---

## 实际使用

### 安装

```bash
git clone https://github.com/sczhou/ProPainter.git
cd ProPainter
pip install -r requirements.txt
```

### 基本使用

```python
# PVTT 中使用 ProPainter 的伪代码

from propainter import ProPainter

# 1. 初始化模型
model = ProPainter(device='cuda')

# 2. 准备输入
# - frames: (T, H, W, 3) 视频帧
# - masks: (T, H, W) 二值掩码 (SAM2 输出)

# 3. 运行修复
inpainted_frames = model.inpaint(
    frames=frames,
    masks=masks,
    flow_mask_dilate=8,  # 光流掩码膨胀
    mask_dilate=4,       # 分割掩码膨胀
)

# 输出: 干净背景视频，商品区域被自然填充
```

### 推荐参数 (PVTT 场景)

```python
config = {
    'flow_mask_dilate': 8,      # 光流掩码膨胀 (处理边缘)
    'mask_dilate': 4,           # 分割掩码膨胀 (覆盖残留)
    'ref_stride': 10,           # 参考帧间隔
    'neighbor_length': 10,      # 邻近帧数量
    'raft_iter': 20,            # RAFT 迭代次数 (光流精度)
}
```

---

## 性能指标

### 速度

| 分辨率 | 帧数 | 时间 (A100) | FPS |
|--------|------|-------------|-----|
| 432×240 | 80 | ~5s | 16 |
| 854×480 | 80 | ~15s | 5.3 |
| 1280×720 | 80 | ~40s | 2 |

### 显存

| 分辨率 | 显存占用 |
|--------|----------|
| 480p | ~6 GB |
| 720p | ~10 GB |
| 1080p | ~16 GB |

### PVTT 成本估算

| 视频规格 | 处理时间 | 备注 |
|----------|----------|------|
| 720p, 50帧 | ~25 秒 | A100 GPU |
| 720p, 100帧 | ~50 秒 | A100 GPU |

---

## 局限性

| 局限 | 描述 | 缓解方案 |
|------|------|----------|
| 大面积遮挡 | 超过帧面积 50% 可能失真 | 分段处理 |
| 复杂纹理 | 细致纹理可能模糊 | 后处理增强 |
| 长视频 | 显存限制 | 分块处理 |
| 快速相机运动 | 光流估计不准 | 提高 RAFT 迭代 |

---

## 与 Pipeline 其他组件的配合

### SAM2 → ProPainter

```
SAM2 输出          ProPainter 输入
───────────────────────────────────
Binary Mask  ────→  Inpainting Mask
              │
              └──→  膨胀处理 (4-8 pixels)
                    消除边缘残留
```

### ProPainter → VideoAnyDoor

```
ProPainter 输出         VideoAnyDoor 输入
───────────────────────────────────────────
干净背景视频      ────→  背景条件
                         (背景 + 新商品 合成)
```

---

## 替代方案对比

| 方案 | 优点 | 缺点 | PVTT 适用性 |
|------|------|------|-------------|
| **ProPainter** | SOTA 质量，开源 | 速度一般 | ✅ 推荐 |
| E²FGVI | 稳定 | 质量略低 | ⚠️ 备选 |
| STTN | 速度快 | 时序不一致 | ❌ 不推荐 |
| 商用 API | 简单 | 成本高，不可控 | ⚠️ PoC 可用 |

---

## 参考文献

- [ProPainter](https://arxiv.org/abs/2309.03897) - ICCV 2023
- [E²FGVI](https://arxiv.org/abs/2204.02663) - 之前 SOTA
- [RAFT](https://arxiv.org/abs/2003.12039) - 光流估计

---

## 相关文档

- [SAM2 分析](sam2-analysis.md) - 提供 Mask 输入
- [VideoAnyDoor 分析](videoanydoor-analysis.md) - 使用修复结果
- [PVTT 数据集方案](../pvtt-dataset-proposal.md) - 完整 Pipeline

---

Last updated: 2026-01-20
