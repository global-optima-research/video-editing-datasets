# PVTT Pipeline 实验总结报告

**日期**: 2026-01-22
**项目**: Product Video Template Transfer (PVTT)
**目标会议**: CVPR 2027 (Deadline: 2026年11月)

---

## 一、项目目标

### 1.1 任务定义

```
输入: 模板视频 (含商品 A) + 目标商品图片 (商品 B)
输出: 编辑视频 (商品 A 被替换为商品 B)
约束: 保持运动轨迹、光照、背景，支持形状变化
```

### 1.2 测试样本

- **源视频**: 手链展示视频 (14.8s, 355帧, 多镜头)
- **目标商品**: 珍珠项链
- **测试片段**: Scene 1 (7.67s, 184帧, 俯拍旋转运镜)

---

## 二、Pipeline 架构与验证状态

```
┌─────────────────────────────────────────────────────────────────────┐
│ Stage 1: 预处理                                                      │
│   ├── [✅ 已验证] 镜头切分 (PySceneDetect)                            │
│   ├── [✅ 已验证] 商品分割 (SAM2 / Grounded SAM 2)                    │
│   └── [⚠️ 有问题] 背景修复 (5种方法均有缺陷)                           │
├─────────────────────────────────────────────────────────────────────┤
│ Stage 2: 视频生成                                                    │
│   ├── [❌ 失败] TI2V 同 seed 方案 (运动无法跨首帧迁移)                 │
│   ├── [📋 待测] RF-Solver Inversion + TI2V                          │
│   └── [📋 待测] VideoAnyDoor 物体插入                                │
├─────────────────────────────────────────────────────────────────────┤
│ Stage 3: 质量评估                                                    │
│   └── [📋 待测] VLM 评估                                             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、实验结果汇总

### 3.1 预处理模块

| 模块 | 方法 | 状态 | 结果 |
|------|------|------|------|
| 镜头切分 | PySceneDetect | ✅ 成功 | 3个镜头，1171 FPS |
| 商品分割 | SAM2 + Point prompt | ✅ 成功 | 184 masks，30 FPS |
| 商品分割 | Grounded SAM 2 | ✅ 成功 | 文本驱动，全自动 |

### 3.2 背景修复对比

| 方法 | 评分 | 阴影移除 | 时序一致 | 速度 | 结论 |
|------|------|---------|---------|------|------|
| ProPainter | 2/10 | ❌ 失败 | ✅ 好 | 0.3s/帧 | 光流方法不适用 |
| LaMa | 6/10 | ✅* 需膨胀mask | ⚠️ 轻微闪烁 | 0.4s/帧 | 可用但有瑕疵 |
| FLUX Fill | 8/10 | ✅ 成功 | ❌ 闪烁 | 23s/帧 | 质量好但不自动化 |
| DiffuEraser | 3/10 | ❌ 失败 | ✅ 好 | 4s/帧 | 继承ProPainter缺陷 |
| OmniEraser | 7/10 | ✅ 成功 | ❌ 闪烁明显 | 30s/帧 | 单帧最佳但视频差 |

**核心矛盾**:
- 光流方法 (ProPainter/DiffuEraser): 时序一致但无法移除全程存在物体的阴影
- 图像方法 (LaMa/FLUX/OmniEraser): 能移除阴影但逐帧处理导致闪烁

### 3.3 运动迁移测试

| 测试 | 配置 | 结果 |
|------|------|------|
| 种子一致性 | 相同首帧 + seed 42 × 2次 | ✅ MD5 完全一致 |
| 跨首帧迁移 v1 | 不同首帧 + seed 42 + 通用prompt | ❌ 运动完全不同 |
| 跨首帧迁移 v2 | 不同首帧 + seed 42 + orbit prompt | ❌ 运动不同且不是orbit |
| 跨首帧迁移 v3 | 不同首帧 + seed 42 + rotate prompt | ❌ 运动不同 |

**结论**: Wan2.2 TI2V 的运动由首帧内容决定，seed 只保证同首帧的确定性，无法实现跨首帧运动迁移。

---

## 四、关键发现

### 4.1 技术发现

1. **背景修复的根本困境**
   - 当物体全程存在时，光流方法无干净背景可借用
   - 需要视频级生成式 inpainting (如 VideoPainter)

2. **运动迁移的根本困境**
   - TI2V 模型的运动生成主要由首帧视觉内容决定
   - Prompt 对运动的控制能力有限
   - 需要显式运动提取方法 (如 RF-Solver Inversion)

3. **自动化分割可行**
   - Grounded SAM 2 = Grounding DINO + SAM2
   - 仅需文本描述即可自动分割，无需手工标注

### 4.2 工程发现

| 指标 | 数值 |
|------|------|
| 镜头切分速度 | ~1000 FPS |
| SAM2 分割速度 | ~30 FPS |
| 背景修复速度 | 0.3-30 s/帧 |
| 单配对处理时间 | 1.5-90 分钟 (取决于方法) |
| 显存需求 | 16-32 GB |

---

## 五、方案对比

### 5.1 已验证方案

| 任务 | 推荐方案 | 理由 |
|------|---------|------|
| 镜头切分 | PySceneDetect | 开源、速度快、效果好 |
| 商品分割 | Grounded SAM 2 | 全自动、准确度高 |

### 5.2 待验证方案

| 任务 | 候选方案 | 优势 | 待验证点 |
|------|---------|------|---------|
| 背景修复 | VideoPainter | 视频级、时序一致 | 阴影处理能力 |
| 运动迁移 | RF-Solver Inversion | 显式运动提取 | 迁移质量 |
| 物体插入 | VideoAnyDoor | Box序列控制 | 形状变化支持 |

### 5.3 已排除方案

| 方案 | 排除原因 |
|------|---------|
| ProPainter 背景修复 | 无法移除全程存在物体的阴影 |
| DiffuEraser 背景修复 | 继承 ProPainter 缺陷 |
| TI2V 同 seed 运动迁移 | 运动由首帧决定，无法跨首帧迁移 |

---

## 六、存在问题

### 6.1 技术问题

1. **背景修复无完美方案**
   - 最好的 OmniEraser 也有视频闪烁
   - 可能需要: VideoPainter 或 后处理稳定

2. **运动迁移方案待验证**
   - RF-Solver Inversion 尚未测试
   - FlowEdit/FlowAlign 也是备选

3. **完整 Pipeline 未打通**
   - VideoAnyDoor 未测试
   - VLM 评估未实装

### 6.2 工程问题

1. **显存限制**: V100 32GB 边缘，部分方法需降分辨率
2. **处理速度**: 高质量方法 (OmniEraser) 30s/帧，成本高
3. **数据集规模**: 52K 配对估计需 100K+ GPU 小时

---

## 七、下一步计划

### 优先级 1: 验证核心假设

| 任务 | 目的 | 预计时间 |
|------|------|---------|
| 测试 RF-Solver Inversion | 验证运动迁移可行性 | 1-2天 |
| 测试 VideoAnyDoor | 验证物体插入+形状变化 | 1-2天 |

### 优先级 2: 解决背景修复

| 任务 | 目的 | 预计时间 |
|------|------|---------|
| 测试 VideoPainter | 视频级 inpainting | 2-3天 |
| 测试 OmniEraser + 后处理 | 稳定闪烁 | 1-2天 |

### 优先级 3: 完整 Pipeline

| 任务 | 目的 | 预计时间 |
|------|------|---------|
| 跑通完整单配对 | 验证端到端可行性 | 1周 |
| 实装 VLM 评估 | 自动质量筛选 | 2-3天 |
| 成本估算 | 确定数据集规模 | 1天 |

---

## 八、实验文件索引

### 8.1 实验日志

| 文件 | 内容 |
|------|------|
| `logs/shot-detection_2026-01-20.md` | 镜头切分实验 |
| `logs/sam2-segmentation_2026-01-20.md` | SAM2 分割实验 |
| `logs/propainter_2026-01-20.md` | ProPainter 修复实验 |
| `logs/lama_2026-01-20.md` | LaMa 修复实验 |
| `logs/flux_fill_2026-01-20.md` | FLUX Fill 修复实验 |
| `logs/diffueraser_2026-01-20.md` | DiffuEraser 修复实验 |
| `logs/omnieraser_2026-01-22.md` | OmniEraser 修复实验 |
| `logs/wan_ti2v_2026-01-22.md` | Wan2.2 TI2V 运动迁移实验 |

### 8.2 实验结果

```
results/
├── shot-detection/      # 镜头切分输出
├── sam2-segmentation/   # 分割 mask
├── propainter/          # ProPainter 修复结果
├── lama/                # LaMa 修复结果
├── flux_fill/           # FLUX Fill 修复结果
├── diffueraser/         # DiffuEraser 修复结果
├── omnieraser/          # OmniEraser 修复结果
└── wan_ti2v/            # TI2V 运动迁移测试
    └── pvtt_reference/  # PVTT benchmark 数据测试
```

---

## 九、结论

### 9.1 已验证可行

- ✅ 镜头切分 (PySceneDetect)
- ✅ 商品分割 (Grounded SAM 2)
- ✅ TI2V 种子确定性 (同首帧可重现)

### 9.2 已验证不可行

- ❌ ProPainter/DiffuEraser 背景修复 (阴影问题)
- ❌ TI2V 同 seed 运动迁移 (运动由首帧决定)

### 9.3 待验证

- 📋 VideoPainter 背景修复
- 📋 RF-Solver Inversion 运动迁移
- 📋 VideoAnyDoor 物体插入
- 📋 完整 Pipeline 端到端

---

**报告作者**: Claude
**最后更新**: 2026-01-22
