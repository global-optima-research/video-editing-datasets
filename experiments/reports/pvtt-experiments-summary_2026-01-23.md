# PVTT Pipeline 实验总结报告 (更新版)

**日期**: 2026-01-23
**项目**: Product Video Template Transfer (PVTT)
**目标会议**: CVPR 2027 (Deadline: 2026年11月)

---

## 一、项目目标

### 1.1 任务定义

```
输入: 模板视频 (含商品 A) + 目标商品图片 (商品 B)
输出: 编辑视频 (商品 A 被替换为商品 B)
约束: 保持运动轨迹、光照、背景，支持形状变化
```

### 1.2 测试样本

- **源视频**: 手链展示视频 (14.8s, 355帧, 多镜头)
- **目标商品**: 珍珠项链
- **测试片段**: Scene 1 (7.67s, 184帧, 俯拍旋转运镜)

---

## 二、方案演进

### 2.1 原方案 (已放弃)

```
源视频 → 分割 → 背景修复 → 首帧编辑 → TI2V(同seed) → 配对视频
```

**遇到的根本性困难**：

| 问题 | 原因 |
|------|------|
| 背景修复困境 | 光流方法无法移除阴影；图像方法有闪烁 |
| 运动迁移困境 | TI2V 运动由首帧决定，无法跨首帧迁移 |

### 2.2 新方案 B：空镜视频 + 物体插入

```
┌─────────────────────────────────────────────────────────┐
│  空镜视频 (无商品的背景视频)                              │
│       │                                                  │
│       ├──── 定义插入区域 (Box 序列)                       │
│       │                                                  │
│       ├──── 插入商品 X ────→ 视频 A ─┐                   │
│       │                              │                   │
│       └──── 插入商品 Y ────→ 视频 B ─┼──→ 配对数据       │
│                                      │                   │
└─────────────────────────────────────────────────────────┘
```

**方案优势**：

| 优势 | 说明 |
|------|------|
| 无需背景修复 | 起点就是干净背景 |
| 无需运动迁移 | 运动由空镜视频提供，两次插入共享 |
| 问题简化 | 只需解决"视频物体插入"一个问题 |
| 易于扩展 | 一个空镜视频可配对多个商品 |

---

## 三、原方案实验结果

### 3.1 预处理模块

| 模块 | 方法 | 状态 | 结果 |
|------|------|------|------|
| 镜头切分 | PySceneDetect | ✅ 成功 | 3个镜头，1171 FPS |
| 商品分割 | SAM2 + Point prompt | ✅ 成功 | 184 masks，30 FPS |
| 商品分割 | Grounded SAM 2 | ✅ 成功 | 文本驱动，全自动 |

### 3.2 背景修复对比

| 方法 | 评分 | 阴影移除 | 时序一致 | 速度 | 结论 |
|------|------|---------|---------|------|------|
| ProPainter | 2/10 | ❌ 失败 | ✅ 好 | 0.3s/帧 | 光流方法不适用 |
| LaMa | 6/10 | ✅* 需膨胀mask | ⚠️ 轻微闪烁 | 0.4s/帧 | 可用但有瑕疵 |
| FLUX Fill | 8/10 | ✅ 成功 | ❌ 闪烁 | 23s/帧 | 质量好但不自动化 |
| DiffuEraser | 3/10 | ❌ 失败 | ✅ 好 | 4s/帧 | 继承ProPainter缺陷 |
| OmniEraser | 7/10 | ✅ 成功 | ❌ 闪烁明显 | 30s/帧 | 单帧最佳但视频差 |

**核心矛盾**:
- 光流方法 (ProPainter/DiffuEraser): 时序一致但无法移除全程存在物体的阴影
- 图像方法 (LaMa/FLUX/OmniEraser): 能移除阴影但逐帧处理导致闪烁

### 3.3 运动迁移测试

| 测试 | 配置 | 结果 |
|------|------|------|
| 种子一致性 | 相同首帧 + seed 42 × 2次 | ✅ MD5 完全一致 |
| 跨首帧迁移 v1 | 不同首帧 + seed 42 + 通用prompt | ❌ 运动完全不同 |
| 跨首帧迁移 v2 | 不同首帧 + seed 42 + orbit prompt | ❌ 运动不同且不是orbit |
| 跨首帧迁移 v3 | 不同首帧 + seed 42 + rotate prompt | ❌ 运动不同 |

**结论**: Wan2.2 TI2V 的运动由首帧内容决定，seed 只保证同首帧的确定性，无法实现跨首帧运动迁移。

---

## 四、视频物体插入方法调研

### 4.1 方法对比

| 方法 | 开源状态 | 视频原生 | Box控制 | 细节保持 | 光照 | 推荐度 |
|------|---------|---------|---------|---------|------|--------|
| VideoAnyDoor | ⚠️ 整理中 | ✅ | ✅ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| InsertAnywhere | ✅ 可用 | ✅ | ✅ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| AnyDoor | ✅ 可用 | ❌ 逐帧 | ✅ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| Add-it | ✅ 可用 | ❌ 仅图像 | ✅ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |

### 4.2 VideoAnyDoor (SIGGRAPH 2025)

**最适合方案 B，但尚未完全开源**

- 论文：https://arxiv.org/abs/2501.01427
- GitHub：https://github.com/yuanpengtu/VideoAnydoor
- 开源状态：⚠️ 代码整理中

**核心能力**：
- 输入：参考图 + Box 序列 + 关键点轨迹（可选）
- 输出：插入物体后的视频
- 运动控制：粗粒度 (Box) + 细粒度 (Pixel Warper)
- 零样本泛化，无需微调

### 4.3 InsertAnywhere (arXiv 2025)

**已开源，4D 几何感知**

- 论文：https://arxiv.org/abs/2512.17504
- GitHub：https://github.com/myyzzzoooo/InsertAnywhere
- 开源状态：✅ 可用

**核心能力**：
- 4D 场景重建，自动处理遮挡
- 光照感知
- 用户可控位置和尺度

### 4.4 AnyDoor (CVPR 2024)

**VideoAnyDoor 的图像版基础，完全开源**

- GitHub：https://github.com/ali-vilab/AnyDoor
- 开源状态：✅ 完全可用

**核心能力**：
- 零样本图像物体插入
- 细节保持好
- 可逐帧处理视频，需后处理平滑

---

## 五、新方案 Pipeline 设计

### 5.1 完整流程

```
Phase 1: 准备空镜视频
├── 来源：拍摄 / 公开数据集 / 视频生成
├── 要求：干净背景，有合适的放置区域
└── 运镜：固定/平移/旋转均可

Phase 2: 定义插入区域
├── 方法：手动标注 / SAM2 辅助 / 自动检测
├── 输出：Box 序列 (每帧的 bounding box)
└── 可选：关键点轨迹 (用于精细运动控制)

Phase 3: 物体插入
├── 输入：空镜视频 + 商品图片 (去背景) + Box 序列
├── 方法：InsertAnywhere / VideoAnyDoor / AnyDoor
└── 输出：合成视频

Phase 4: 质量评估
├── VLM 自动评估
├── 人工抽检
└── 筛选高质量配对
```

### 5.2 扩展性估算

一个空镜视频 + N 个商品 = N×(N-1)/2 个配对

| 空镜视频数 | 商品数 | 配对数 |
|-----------|--------|--------|
| 10 | 100 | 49,500 |
| 50 | 100 | 247,500 |
| 100 | 100 | 495,000 |

---

## 六、下一步计划

### 优先级 1：验证物体插入

| 任务 | 目的 |
|------|------|
| 测试 InsertAnywhere | 验证已开源方案的效果 |
| 准备测试数据 | 空镜视频 + 商品图片 |
| 评估插入质量 | 时序一致性、光照匹配、形状适配 |

### 优先级 2：完善 Pipeline

| 任务 | 目的 |
|------|------|
| Box 序列生成方案 | 自动化或半自动化 |
| 批量处理脚本 | 支持大规模生成 |
| 质量筛选机制 | VLM 自动评估 |

### 优先级 3：数据准备

| 任务 | 目的 |
|------|------|
| 空镜视频来源 | 拍摄或获取公开数据 |
| 商品图片收集 | 去背景处理 |
| 数据集规模规划 | 成本和时间估算 |

---

## 七、已验证结论

### 7.1 已验证可行

- ✅ 镜头切分 (PySceneDetect)
- ✅ 商品分割 (Grounded SAM 2)
- ✅ TI2V 种子确定性 (同首帧可重现)

### 7.2 已验证不可行

- ❌ ProPainter/DiffuEraser 背景修复 (阴影问题)
- ❌ TI2V 同 seed 运动迁移 (运动由首帧决定)

### 7.3 待验证 (新方案)

- 📋 InsertAnywhere 物体插入
- 📋 VideoAnyDoor 物体插入 (等待开源)
- 📋 空镜视频 + 物体插入配对生成

---

## 八、参考资料

### 论文

- [VideoAnyDoor: High-fidelity Video Object Insertion](https://arxiv.org/abs/2501.01427) - SIGGRAPH 2025
- [InsertAnywhere: Bridging 4D Scene Geometry and Diffusion Models](https://arxiv.org/abs/2512.17504) - arXiv 2025
- [AnyDoor: Zero-shot Object-level Image Customization](https://arxiv.org/abs/2307.09481) - CVPR 2024
- [Add-it: Training-Free Object Insertion in Images](https://arxiv.org/abs/2411.07232) - ICLR 2025

### GitHub

- VideoAnyDoor: https://github.com/yuanpengtu/VideoAnydoor
- InsertAnywhere: https://github.com/myyzzzoooo/InsertAnywhere
- AnyDoor: https://github.com/ali-vilab/AnyDoor
- Add-it: https://github.com/NVlabs/addit

---

**报告作者**: Claude
**最后更新**: 2026-01-23
