# LaMa 实验记录

## 实验信息

- **日期**: 2025-01-20
- **目标**: 使用 LaMa 逐帧修复视频，移除手链并生成干净背景
- **模型**: LaMa (big-lama.pt)
- **GPU**: NVIDIA V100 32GB (5090 服务器)

## 输入数据

- **源视频**: `custom.mp4`
  - 分辨率: 1280x1024
  - 帧数: 184 帧
  - 内容: 紫色桌面上的手链饰品

- **遮罩**: SAM2 分割结果 + 膨胀处理
  - 原始 mask 只覆盖手链轮廓线
  - 膨胀后覆盖整个手链区域及阴影

## 实验配置

```python
from simple_lama_inpainting import SimpleLama
from PIL import Image
import cv2
import numpy as np

# 膨胀 mask 以覆盖阴影
kernel = np.ones((50, 50), np.uint8)
mask_dilated = cv2.dilate(mask_uint8, kernel, iterations=3)

# 填充内部空洞
contours, _ = cv2.findContours(mask_dilated, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
mask_filled = np.zeros_like(mask_dilated)
cv2.drawContours(mask_filled, contours, -1, 255, -1)

# LaMa 修复
simple_lama = SimpleLama()
result = simple_lama(image, mask_pil)
```

### 关键参数
- **膨胀核大小**: 50x50
- **膨胀迭代次数**: 3
- **处理分辨率**: 原始 1280x1024（无需降分辨率）

## 实验结果

### 输出文件
```
results/lama/
├── lama_inpainted.mp4           # 修复后视频
├── frame_000_original.png       # 原始帧示例
├── frame_000_mask.png           # 原始 mask（仅轮廓）
├── frame_000_mask_dilated.png   # 膨胀后 mask
├── frame_000_inpainted.png      # 修复结果（v1，mask 未膨胀）
└── v2_frame_*.png               # 最终结果抽帧
```

### 效果评估

**评分: 6/10 - 可用但有瑕疵**

#### 优点

1. **手链移除成功**: 手链本体完全移除
2. **阴影移除成功**: 通过膨胀 mask，阴影也被覆盖并移除
3. **显存友好**: 1280x1024 分辨率无需降分辨率，32GB GPU 轻松运行
4. **处理速度快**: 184 帧约 76 秒（~2.4 fps）

#### 问题

1. **填充色差**: 填充区域有轻微色差（偏绿/偏白色块）
2. **无时序一致性**: 逐帧独立处理，视频有轻微闪烁
3. **边缘不自然**: 部分帧填充边缘过渡不够自然

#### 关键发现

**原始 mask 问题**: SAM2 生成的 mask 只覆盖手链的轮廓线（环形），不包括：
- 手链内部透明区域
- 手链投射的阴影

**解决方案**: 大幅膨胀 mask（50x50 kernel, 3 iterations）+ 填充内部空洞

## 与其他方法对比

| 特性 | LaMa | ProPainter |
|------|------|------------|
| 方法类型 | 图像修复（逐帧） | 视频修复（光流传播） |
| 阴影处理 | ✅ 成功（需膨胀 mask） | ❌ 失败 |
| 时序一致性 | ❌ 无 | ✅ 有 |
| 填充质量 | 中等（有色差） | 差（只能传播已有像素） |
| 处理速度 | ~2.4 fps | ~3 fps |
| 显存需求 | ~8GB | ~16GB (720p) |
| 评分 | 6/10 | 2/10 |

## 结论

LaMa **可用于本任务**，但有改进空间：

1. **时序一致性**: 可尝试添加视频稳定后处理
2. **填充质量**: 可尝试 FLUX Fill 等更强的生成式模型
3. **Mask 处理**: 膨胀参数可能需要根据不同视频调整

## 后续建议

1. 尝试 FLUX Fill 逐帧处理（更强的生成能力）
2. 添加视频稳定后处理（如 optical flow based stabilization）
3. 或在更大显存 GPU 上测试 VideoPainter

## 服务器路径

- 模型权重: `~/.cache/torch/hub/checkpoints/big-lama.pt`
- 输出结果: `/data/xuhao/lama_test_v2/`
